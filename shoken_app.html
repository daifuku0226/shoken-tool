<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>é€šçŸ¥è¡¨æ‰€è¦‹ä½œæˆã‚¢ã‚·ã‚¹ã‚¿ãƒ³ãƒˆï¼ˆGemini AIç‰ˆï¼‰</title>
<script src="https://cdn.sheetjs.com/xlsx-0.20.0/package/dist/xlsx.full.min.js"></script>
<style>
* { margin: 0; padding: 0; box-sizing: border-box; }
body { font-family: 'Hiragino Sans', 'Noto Sans JP', 'Yu Gothic', sans-serif; background: #f0f4f8; color: #2d3748; line-height: 1.7; }
.container { max-width: 800px; margin: 0 auto; padding: 20px; }
header { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 24px; border-radius: 16px; margin-bottom: 24px; text-align: center; }
header h1 { font-size: 1.5em; margin-bottom: 4px; }
header p { font-size: 0.9em; opacity: 0.9; }
.card { background: white; border-radius: 12px; padding: 24px; margin-bottom: 20px; box-shadow: 0 2px 8px rgba(0,0,0,0.08); }
.card h2 { font-size: 1.15em; color: #4a5568; margin-bottom: 16px; padding-bottom: 8px; border-bottom: 2px solid #e2e8f0; }
label { display: block; font-weight: bold; margin-bottom: 6px; color: #4a5568; font-size: 0.95em; }
input[type="text"], textarea { width: 100%; padding: 10px 14px; border: 2px solid #e2e8f0; border-radius: 8px; font-size: 1em; font-family: inherit; transition: border-color 0.2s; }
input[type="text"]:focus, textarea:focus { outline: none; border-color: #667eea; }
textarea { resize: vertical; min-height: 70px; }
.btn { display: inline-block; padding: 12px 28px; border: none; border-radius: 8px; font-size: 1em; font-weight: bold; cursor: pointer; transition: all 0.2s; font-family: inherit; }
.btn-primary { background: linear-gradient(135deg, #667eea, #764ba2); color: white; }
.btn-primary:hover { transform: translateY(-1px); box-shadow: 0 4px 12px rgba(102,126,234,0.4); }
.btn-secondary { background: #edf2f7; color: #4a5568; }
.btn-secondary:hover { background: #e2e8f0; }
.btn-success { background: linear-gradient(135deg, #48bb78, #38a169); color: white; }
.btn-success:hover { transform: translateY(-1px); box-shadow: 0 4px 12px rgba(72,187,120,0.4); }
.btn-danger { background: #fc8181; color: white; }
.btn-danger:hover { background: #f56565; }
.btn:disabled { opacity: 0.5; cursor: not-allowed; transform: none; }
.btn-group { display: flex; gap: 10px; flex-wrap: wrap; margin-top: 16px; }
.pattern-box { border: 2px solid #e2e8f0; border-radius: 10px; padding: 16px; margin-bottom: 14px; transition: border-color 0.2s; position: relative; cursor: pointer; }
.pattern-box:hover { border-color: #a3bffa; }
.pattern-box.selected { border-color: #667eea; background: #f7f8ff; }
.pattern-label { font-weight: bold; color: #667eea; margin-bottom: 8px; font-size: 0.95em; }
.pattern-text { font-size: 1em; line-height: 1.8; }
.char-count { text-align: right; font-size: 0.85em; color: #718096; margin-top: 4px; }
.char-count.warn { color: #e53e3e; font-weight: bold; }
.char-count.ok { color: #38a169; }
.progress-bar { width: 100%; height: 6px; background: #e2e8f0; border-radius: 3px; overflow: hidden; margin: 12px 0; }
.progress-fill { height: 100%; background: linear-gradient(90deg, #667eea, #764ba2); border-radius: 3px; transition: width 0.5s; }
.status-msg { text-align: center; padding: 12px; color: #667eea; font-weight: bold; font-size: 0.95em; }
.data-table { width: 100%; border-collapse: collapse; margin-top: 12px; font-size: 0.85em; }
.data-table th, .data-table td { border: 1px solid #e2e8f0; padding: 8px 10px; text-align: left; }
.data-table th { background: #f7fafc; font-weight: bold; color: #4a5568; }
.data-table tr:hover { background: #f7f8ff; }
.hidden { display: none !important; }
.api-section { background: #fffff0; border: 2px solid #ecc94b; border-radius: 12px; padding: 20px; margin-bottom: 20px; }
.api-section label { color: #744210; }
.api-input-wrap { display: flex; gap: 8px; }
.api-input-wrap input { flex: 1; }
.modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); display: flex; align-items: center; justify-content: center; z-index: 1000; }
.modal-content { background: white; border-radius: 16px; padding: 28px; max-width: 500px; width: 90%; }
.modal-content h3 { margin-bottom: 16px; color: #2d3748; }
.edit-area { width: 100%; min-height: 120px; padding: 12px; border: 2px solid #e2e8f0; border-radius: 8px; font-family: inherit; font-size: 1em; line-height: 1.8; resize: vertical; }
.edit-area:focus { outline: none; border-color: #667eea; }
.info-box { background: #ebf8ff; border-left: 4px solid #3182ce; padding: 12px 16px; border-radius: 0 8px 8px 0; margin: 12px 0; font-size: 0.9em; color: #2c5282; }
.trim-notice { background: #fefcbf; border-left: 4px solid #ecc94b; padding: 10px 14px; border-radius: 0 8px 8px 0; margin-top: 6px; font-size: 0.82em; color: #744210; }
.quota-info { background: #f0fff4; border: 1px solid #c6f6d5; border-radius: 8px; padding: 10px 14px; margin-top: 10px; font-size: 0.82em; color: #276749; }
.version-info { text-align: center; padding: 8px; color: #a0aec0; font-size: 0.75em; }
@media (max-width: 600px) {
  .container { padding: 12px; }
  header { padding: 16px; }
  header h1 { font-size: 1.2em; }
  .card { padding: 16px; }
  .btn-group { flex-direction: column; }
  .btn { width: 100%; text-align: center; }
}
</style>
</head>
<body>
<div class="container">
  <header>
    <h1>é€šçŸ¥è¡¨ æ‰€è¦‹ä½œæˆã‚¢ã‚·ã‚¹ã‚¿ãƒ³ãƒˆ</h1>
    <p>Gemini AI ãŒãƒ—ãƒ­ã®è¡¨ç¾åŠ›ã§2ãƒ‘ã‚¿ãƒ¼ãƒ³ã®æ‰€è¦‹ã‚’ç”Ÿæˆã—ã¾ã™</p>
  </header>

  <div class="api-section" id="apiSection">
    <label>ğŸ”‘ Gemini APIã‚­ãƒ¼ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„</label>
    <p style="font-size:0.85em; color:#744210; margin: 6px 0 10px;">APIã‚­ãƒ¼ã¯ç«¯æœ«ã«ä¿å­˜ã•ã‚Œã€å¤–éƒ¨é€ä¿¡ã¯Gemini APIã¸ã®é€šä¿¡ã®ã¿ã§ã™</p>
    <div class="api-input-wrap">
      <input type="password" id="apiKeyInput" placeholder="AIzaSy... ã§å§‹ã¾ã‚‹ã‚­ãƒ¼ã‚’è²¼ã‚Šä»˜ã‘">
      <button class="btn btn-primary" onclick="saveApiKey()">ä¿å­˜</button>
    </div>
    <p id="apiStatus" style="margin-top:8px; font-size:0.85em;"></p>
    <div class="quota-info">
      ğŸ“Š æœ¬æ—¥ã®ä½¿ç”¨ï¼š<strong><span id="usageCount">0</span>å›</strong>ï¼ˆãƒ¢ãƒ‡ãƒ«ï¼šGemini 2.5 Flash-Lite ï¼ ç„¡æ–™æ ï¼š1æ—¥1,000å›ä»¥ä¸Šï¼‰
    </div>
  </div>

  <div class="card" id="step1">
    <h2>ğŸ“ STEP1ï¼šç”Ÿå¾’ã®ç‰¹å¾´ã‚’æ•™ãˆã¦ãã ã•ã„</h2>
    <div style="margin-bottom:14px;">
      <label>ç”Ÿå¾’åï¼ˆç•ªå·ã§ã‚‚OKï¼‰</label>
      <input type="text" id="studentName" placeholder="ä¾‹ï¼š1ç•ªã€Aå­">
    </div>
    <div style="margin-bottom:14px;">
      <label>â‘  æ€§æ ¼ãƒ»è¡Œå‹•é¢ã®ç‰¹å¾´</label>
      <textarea id="feature1" placeholder="ä¾‹ï¼šæ˜ã‚‹ãç¤¾äº¤çš„ã€å›°ã£ã¦ã„ã‚‹å‹äººã«å£°ã‚’ã‹ã‘ã‚‹æ€ã„ã‚„ã‚ŠãŒã‚ã‚‹"></textarea>
    </div>
    <div style="margin-bottom:14px;">
      <label>â‘¡ å­¦ç¿’çŠ¶æ³</label>
      <textarea id="feature2" placeholder="ä¾‹ï¼šç†ç§‘ã®å®Ÿé¨“ã«é–¢å¿ƒãŒé«˜ã„ã€ãƒ¬ãƒãƒ¼ãƒˆã®è€ƒå¯ŸãŒä¸å¯§ã€æ•°å­¦ã¯ç²˜ã‚Šå¼·ãå–ã‚Šçµ„ã‚€"></textarea>
    </div>
    <div style="margin-bottom:14px;">
      <label>â‘¢ è«¸æ´»å‹•ã¸ã®å–ã‚Šçµ„ã¿</label>
      <textarea id="feature3" placeholder="ä¾‹ï¼šåˆå”±ã‚³ãƒ³ã‚¯ãƒ¼ãƒ«ã§ãƒ‘ãƒ¼ãƒˆãƒªãƒ¼ãƒ€ãƒ¼ã€æœç·´ã‚’æ¬ ã‹ã•ãšå‚åŠ "></textarea>
    </div>
    <div style="margin-bottom:14px;">
      <label>â‘£ ãã®ä»–ãƒ»è£œè¶³ï¼ˆä»»æ„ï¼‰</label>
      <textarea id="feature4" placeholder="ä¾‹ï¼šæå‡ºç‰©ã®æœŸé™ã‚’å®ˆã‚Œãªã„ã“ã¨ãŒã‚ã‚‹" style="min-height:50px;"></textarea>
    </div>
    <div class="btn-group">
      <button class="btn btn-primary" onclick="generateShoken()">âœ¨ æ‰€è¦‹ã‚’ç”Ÿæˆã™ã‚‹</button>
    </div>
  </div>

  <div class="card hidden" id="step2">
    <h2>ğŸ“„ STEP2ï¼šç”Ÿæˆã•ã‚ŒãŸæ‰€è¦‹ï¼ˆ2ãƒ‘ã‚¿ãƒ¼ãƒ³ï¼‰</h2>
    <div class="info-box">åŒã˜åˆ‡ã‚Šå£ã§ã€è¡¨ç¾ã®å¼•ãå‡ºã—ã‚’å¤‰ãˆãŸ2ãƒ‘ã‚¿ãƒ¼ãƒ³ã§ã™ã€‚ãŠå¥½ã¿ã®æ–¹ã‚’é¸ã‚“ã§ãã ã•ã„ã€‚</div>
    <div id="patternsArea"></div>
    <div id="progressArea" class="hidden">
      <div class="progress-bar"><div class="progress-fill" id="progressFill" style="width:0%"></div></div>
      <p class="status-msg" id="statusMsg">ç”Ÿæˆä¸­...</p>
    </div>
    <div class="btn-group hidden" id="step2Buttons">
      <button class="btn btn-primary" onclick="selectPattern('A')">ãƒ‘ã‚¿ãƒ¼ãƒ³Aã‚’é¸æŠ</button>
      <button class="btn btn-primary" onclick="selectPattern('B')">ãƒ‘ã‚¿ãƒ¼ãƒ³Bã‚’é¸æŠ</button>
      <button class="btn btn-secondary" onclick="requestRevision()">ğŸ”„ ä¿®æ­£ã‚’ä¾é ¼ã™ã‚‹</button>
      <button class="btn btn-secondary" onclick="backToStep1()">â† å…¥åŠ›ã«æˆ»ã‚‹</button>
    </div>
  </div>

  <div class="modal-overlay hidden" id="revisionModal">
    <div class="modal-content">
      <h3>ğŸ”„ ä¿®æ­£ã‚’ä¾é ¼ã™ã‚‹</h3>
      <label>ã©ã®ã‚ˆã†ã«ä¿®æ­£ã—ã¾ã™ã‹ï¼Ÿ</label>
      <textarea id="revisionInput" class="edit-area" placeholder="ä¾‹ï¼šå­¦ç¿’é¢ã‚’ã‚‚ã£ã¨å¼·èª¿ã—ã¦ã»ã—ã„"></textarea>
      <div class="btn-group" style="margin-top:14px;">
        <button class="btn btn-primary" onclick="executeRevision()">å†ç”Ÿæˆã™ã‚‹</button>
        <button class="btn btn-secondary" onclick="closeRevisionModal()">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
      </div>
    </div>
  </div>

  <div class="card hidden" id="step3">
    <h2>âœï¸ STEP3ï¼šæœ€çµ‚ç·¨é›†</h2>
    <p style="font-size:0.9em; color:#718096; margin-bottom:12px;">å¿…è¦ã«å¿œã˜ã¦æ‰‹ç›´ã—ã—ã¦ç¢ºå®šã—ã¦ãã ã•ã„ï¼ˆ126æ–‡å­—ä»¥å†…ï¼‰</p>
    <textarea id="finalEdit" class="edit-area" oninput="updateFinalCount()"></textarea>
    <div class="char-count" id="finalCount">0æ–‡å­—</div>
    <div class="btn-group">
      <button class="btn btn-success" onclick="confirmShoken()">âœ… ã“ã®æ‰€è¦‹ã§ç¢ºå®šã™ã‚‹</button>
      <button class="btn btn-secondary" onclick="backToStep2()">â† ãƒ‘ã‚¿ãƒ¼ãƒ³é¸æŠã«æˆ»ã‚‹</button>
    </div>
  </div>

  <div class="card" id="dataSection">
    <h2>ğŸ“Š ä½œæˆæ¸ˆã¿ãƒ‡ãƒ¼ã‚¿ï¼ˆ<span id="dataCount">0</span>ä»¶ï¼‰</h2>
    <div id="dataTableWrap"><p style="color:#a0aec0; font-size:0.9em;">ã¾ã ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“</p></div>
    <div class="btn-group">
      <button class="btn btn-success" onclick="exportData()" id="exportBtn" disabled>ğŸ“¥ Excelå‡ºåŠ›</button>
      <button class="btn btn-secondary" onclick="exportCSV()" id="csvBtn" disabled>ğŸ“¥ CSVå‡ºåŠ›</button>
      <button class="btn btn-danger" onclick="clearAllData()" id="clearBtn" disabled>ğŸ—‘ å…¨ãƒ‡ãƒ¼ã‚¿æ¶ˆå»</button>
    </div>
  </div>

  <div class="version-info">v4.0 â”€ ãƒ—ãƒ­ãƒ©ã‚¤ã‚¿ãƒ¼å“è³ªç‰ˆ ï¼ Gemini 2.5 Flash-Lite ï¼ 126æ–‡å­—å³å®ˆ</div>
</div>

<script>
var MIN_CHARS = 110;
var MAX_CHARS = 126;
var MODEL_NAME = 'gemini-2.5-flash-lite';

var apiKey = localStorage.getItem('gemini_api_key') || '';
var shokenData = JSON.parse(localStorage.getItem('shoken_data') || '[]');
var currentPatterns = { A: '', B: '' };
var currentTrimmed = { A: false, B: false };
var currentFeatures = {};
var revisionHistory = [];

function getTodayKey() { return 'usage_' + new Date().toISOString().slice(0, 10); }
function getUsageCount() { return parseInt(localStorage.getItem(getTodayKey()) || '0'); }
function addUsage() { var c = getUsageCount() + 1; localStorage.setItem(getTodayKey(), c); document.getElementById('usageCount').textContent = c; }
function updateUsageDisplay() { document.getElementById('usageCount').textContent = getUsageCount(); }

window.onload = function() {
  if (apiKey) {
    document.getElementById('apiKeyInput').value = 'â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢';
    document.getElementById('apiStatus').innerHTML = 'âœ… APIã‚­ãƒ¼è¨­å®šæ¸ˆã¿';
    document.getElementById('apiStatus').style.color = '#38a169';
  }
  updateDataDisplay();
  updateUsageDisplay();
};

function saveApiKey() {
  var key = document.getElementById('apiKeyInput').value.trim();
  if (!key || key === 'â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢') { alert('APIã‚­ãƒ¼ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„'); return; }
  if (!key.startsWith('AIza')) { alert('APIã‚­ãƒ¼ã¯AIzaSy...ã§å§‹ã¾ã‚‹å½¢å¼ã§ã™ã€‚'); return; }
  apiKey = key;
  localStorage.setItem('gemini_api_key', key);
  document.getElementById('apiKeyInput').value = 'â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢';
  document.getElementById('apiStatus').innerHTML = 'âœ… APIã‚­ãƒ¼ã‚’ä¿å­˜ã—ã¾ã—ãŸï¼';
  document.getElementById('apiStatus').style.color = '#38a169';
}

function convertMotsu(text) {
  text = text.replace(/æŒã¡å‰/g, 'ã‚‚ã¡å‰');
  text = text.replace(/æŒã¡å‘³/g, 'ã‚‚ã¡å‘³');
  text = text.replace(/æ°—æŒã¡/g, 'æ°—ã‚‚ã¡');
  text = text.replace(/ç›®æ¨™ã‚’æŒã£ã¦/g, 'ç›®æ¨™ã‚’ã‚‚ã£ã¦');
  text = text.replace(/æ„æ¬²ã‚’æŒã£ã¦/g, 'æ„æ¬²ã‚’ã‚‚ã£ã¦');
  text = text.replace(/é–¢å¿ƒã‚’æŒ/g, 'é–¢å¿ƒã‚’ã‚‚');
  text = text.replace(/èˆˆå‘³ã‚’æŒ/g, 'èˆˆå‘³ã‚’ã‚‚');
  text = text.replace(/è‡ªä¿¡ã‚’æŒ/g, 'è‡ªä¿¡ã‚’ã‚‚');
  text = text.replace(/èª‡ã‚Šã‚’æŒ/g, 'èª‡ã‚Šã‚’ã‚‚');
  text = text.replace(/è²¬ä»»æ„Ÿã‚’æŒ/g, 'è²¬ä»»æ„Ÿã‚’ã‚‚');
  text = text.replace(/æ€ã„ã‚„ã‚Šã‚’æŒ/g, 'æ€ã„ã‚„ã‚Šã‚’ã‚‚');
  text = text.replace(/å¤¢ã‚’æŒ/g, 'å¤¢ã‚’ã‚‚');
  text = text.replace(/å¸Œæœ›ã‚’æŒ/g, 'å¸Œæœ›ã‚’ã‚‚');
  text = text.replace(/ä¿¡å¿µã‚’æŒ/g, 'ä¿¡å¿µã‚’ã‚‚');
  text = text.replace(/å¿—ã‚’æŒ/g, 'å¿—ã‚’ã‚‚');
  text = text.replace(/è¦–é‡ã‚’æŒ/g, 'è¦–é‡ã‚’ã‚‚');
  text = text.replace(/(\S)ã‚’æŒã£ã¦/g, function(m, p1) {
    var ph = ['æ‰‹','è·ç‰©','ã‚«ãƒãƒ³','é„','å‚˜','æœ¬','ãƒœãƒ¼ãƒ«'];
    return ph.some(function(w) { return p1.includes(w); }) ? m : p1 + 'ã‚’ã‚‚ã£ã¦';
  });
  text = text.replace(/(\S)ã‚’æŒã¡/g, function(m, p1) {
    var ph = ['æ‰‹','è·ç‰©','ã‚«ãƒãƒ³','é„','å‚˜','æœ¬','ãƒœãƒ¼ãƒ«'];
    return ph.some(function(w) { return p1.includes(w); }) ? m : p1 + 'ã‚’ã‚‚ã¡';
  });
  return text;
}
function enforceMaxChars(text, max) {
  if (!max) max = MAX_CHARS;
  if (!text) return { text: '', trimmed: false };
  text = text.replace(/æŒã¤/g, 'ã‚‚ã¤')
             .replace(/æŒã£ã¦/g, 'ã‚‚ã£ã¦')
             .replace(/æŒã¡å‰/g, 'ã‚‚ã¡å‰')
             .replace(/æŒã£ãŸ/g, 'ã‚‚ã£ãŸ')
             .replace(/æŒã¡/g, 'ã‚‚ã¡');
  if (text.length <= max) return { text: text, trimmed: false };
  var trimmed = text.substring(0, max);
  var lastPeriod = trimmed.lastIndexOf('ã€‚');
  if (lastPeriod >= 0) {
    return { text: trimmed.substring(0, lastPeriod + 1), trimmed: true };
  }
  return { text: trimmed.substring(0, max - 1) + 'ã€‚', trimmed: true };
}



function sleep(ms) { return new Promise(function(r) { setTimeout(r, ms); }); }

function cleanShokenText(text) {
  text = text.replace(/^ãƒ‘ã‚¿ãƒ¼ãƒ³[AB][\sï¼š:]*/i, '');
  text = text.replace(/^---.*?---\s*/g, '');
  text = text.replace(/^[\sã€Œã€ã€ã€]+/, '');
  text = text.replace(/[\sã€Œã€ã€ã€]+$/, '');
  text = text.replace(/^\*+/g, '');
  text = text.replace(/\*+$/g, '');
  text = text.replace(/ï¼ˆ\d+æ–‡å­—ï¼‰/g, '');
  text = text.replace(/\(\d+æ–‡å­—\)/g, '');
  text = text.replace(/ã€.*?æ–‡å­—.*?ã€‘/g, '');
  text = text.replace(/\n/g, '');
  return text.trim();
}

async function callGemini(prompt, retryCount) {
  retryCount = retryCount || 0;
  var url = 'https://generativelanguage.googleapis.com/v1beta/models/' + MODEL_NAME + ':generateContent?key=' + apiKey;
  var body = { contents: [{ parts: [{ text: prompt }] }], generationConfig: { temperature: 0.8, maxOutputTokens: 512 } };
  try {
    var res = await fetch(url, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(body) });
    if (!res.ok) {
      var ed = await res.json().catch(function() { return {}; });
      var em = (ed && ed.error && ed.error.message) ? ed.error.message : res.statusText;
      if (res.status === 429 && retryCount < 2) {
        updateProgress(-1, 'â³ ãƒ¬ãƒ¼ãƒˆåˆ¶é™ä¸­...15ç§’å¾…ã¡ã¾ã™');
        await sleep(15000);
        return callGemini(prompt, retryCount + 1);
      }
      throw new Error('API Error (' + res.status + '): ' + em);
    }
    var data = await res.json();
    addUsage();
    var resultText = '';
    if (data.candidates && data.candidates[0] && data.candidates[0].content) {
      var parts = data.candidates[0].content.parts;
      for (var i = 0; i < parts.length; i++) { if (parts[i].text) resultText += parts[i].text; }
    }
    return resultText.trim();
  } catch (e) {
    if (retryCount < 1) { await sleep(5000); return callGemini(prompt, retryCount + 1); }
    throw e;
  }
}
function buildPrompt(type, f1, f2, f3, f4, prevText, revision) {
  const voiceA = 'ã‚„ã‚ã‚‰ã‹ãæ¸©ã‹ã„è¨€è‘‰ã‚’é¸ã‚“ã§ãã ã•ã„ã€‚è¦ªã—ã¿ã‚„ã™ãã€ä¿è­·è€…ãŒã€Œã†ã¡ã®å­ã‚’ã‚ˆãè¦‹ã¦ãã‚Œã¦ã„ã‚‹ã€ã¨å®‰å¿ƒã§ãã‚‹ã‚ˆã†ãªã€æ—¥å¸¸çš„ã§ã‚„ã•ã—ã„èªå½™ã‚’ä½¿ã£ãŸè¡¨ç¾ã«ã—ã¦ãã ã•ã„ã€‚é›£ã—ã„è¨€è‘‰ã¯é¿ã‘ã€ç´ æœ´ã§å¿ƒã«å±Šãè¨€è‘‰é¸ã³ã‚’æ„è­˜ã—ã¦ãã ã•ã„ã€‚';
  const voiceB = 'èªå½™åŠ›ã®è±Šã‹ã•ãŒä¼ã‚ã‚‹çŸ¥çš„ã§æ´—ç·´ã•ã‚ŒãŸè¡¨ç¾ã‚’ä½¿ã£ã¦ãã ã•ã„ã€‚ã€Œã“ã®å…ˆç”Ÿã¯è¨€è‘‰ã‚’ã‚ˆãçŸ¥ã£ã¦ã„ã‚‹ãªã€ã¨ä¿è­·è€…ã«æ€ã‚ã›ã‚‹ã‚ˆã†ãªã€çš„ç¢ºã§æ ¼èª¿ã‚ã‚‹è¨€ã„å›ã—ã‚’é¸ã‚“ã§ãã ã•ã„ã€‚æ¯”å–©ã‚„æ…£ç”¨è¡¨ç¾ã‚‚é©åˆ‡ã«å–ã‚Šå…¥ã‚Œã€è¡¨ç¾ã®å¹…åºƒã•ã‚’æ„Ÿã˜ã•ã›ã‚‹æ–‡ç« ã«ã—ã¦ãã ã•ã„ã€‚';
  const voice = (type === 'A') ? voiceA : voiceB;

  let base = '';
  if (prevText && revision) {
    base = 'ä»¥ä¸‹ã®æ‰€è¦‹æ–‡ã‚’ä¿®æ­£ã—ã¦ãã ã•ã„ã€‚\n'
      + 'ã€å…ƒã®æ‰€è¦‹ã€‘\n' + prevText + '\n'
      + 'ã€ä¿®æ­£ä¾é ¼ã€‘\n' + revision + '\n\n';
  }

  const prompt = base
    + 'ã‚ãªãŸã¯ãƒ™ãƒ†ãƒ©ãƒ³å°å­¦æ ¡æ•™å¸«ã§ã‚ã‚Šã€é€šçŸ¥è¡¨ã®æ‰€è¦‹ã‚’æ›¸ããƒ—ãƒ­ã®ãƒ©ã‚¤ã‚¿ãƒ¼ã§ã™ã€‚\n'
    + 'ä»¥ä¸‹ã®3ã¤ã®è¦³ç‚¹ã‹ã‚‰ã€é€šçŸ¥è¡¨ã®æ‰€è¦‹ã‚’3æ–‡ã§ä½œæˆã—ã¦ãã ã•ã„ã€‚\n\n'
    + 'ã€è¦³ç‚¹Aã€‘æ€§æ ¼ãƒ»è¡Œå‹•é¢: ' + f1 + '\n'
    + 'ã€è¦³ç‚¹Bã€‘å­¦ç¿’çŠ¶æ³: ' + f2 + '\n'
    + 'ã€è¦³ç‚¹Cã€‘è«¸æ´»å‹•ã¸ã®å–ã‚Šçµ„ã¿: ' + f3 + '\n'
    + (f4 ? 'ã€è£œè¶³æƒ…å ±ã€‘' + f4 + '\n' : '')
    + '\n'
    + 'â–  æ§‹æˆãƒ«ãƒ¼ãƒ«\n'
    + 'ãƒ»ç¬¬1æ–‡ã¯ã€è¦³ç‚¹Aã€‘æ€§æ ¼ãƒ»è¡Œå‹•é¢ã®ã¿ã‚’æ‰±ã†ã“ã¨ã€‚\n'
    + 'ãƒ»ç¬¬2æ–‡ã¯ã€è¦³ç‚¹Bã€‘å­¦ç¿’çŠ¶æ³ã®ã¿ã‚’æ‰±ã†ã“ã¨ã€‚\n'
    + 'ãƒ»ç¬¬3æ–‡ã¯ã€è¦³ç‚¹Cã€‘è«¸æ´»å‹•ã¸ã®å–ã‚Šçµ„ã¿ã‚’å¿…ãšå…·ä½“çš„ã«æ›¸ã„ãŸä¸Šã§ã€ã“ã‚Œã‹ã‚‰ã¸ã®æ„æ¬²å–šèµ·ã‚’è‡ªç„¶ã«å«ã‚ã‚‹ã“ã¨ã€‚ç¬¬3æ–‡ã«è¦³ç‚¹Cã®å†…å®¹ãŒå…¥ã£ã¦ã„ãªã‘ã‚Œã°çµ¶å¯¾ã«ã‚„ã‚Šç›´ã™ã“ã¨ã€‚\n'
    + 'ãƒ»å„æ–‡ã¯ãã‚Œãã‚Œã®è¦³ç‚¹ã ã‘ã‚’æ‰±ã„ã€è¤‡æ•°ã®è¦³ç‚¹ã‚’1æ–‡ã«ã¾ã¨ã‚ãªã„ã“ã¨ã€‚\n'
    + 'ãƒ»å…¥åŠ›ã•ã‚ŒãŸèªã‚’ãã®ã¾ã¾ç¹°ã‚Šè¿”ã•ãšã€ãƒ‹ãƒ¥ã‚¢ãƒ³ã‚¹ã‚’æ±²ã¿å–ã£ã¦è‡ªåˆ†ã®è¨€è‘‰ã§æ›¸ãç›´ã™ã“ã¨ã€‚\n'
    + 'ãƒ»ç”Ÿå¾’ã®é ‘å¼µã‚Šã‚’ã€Œçµæœã€ã§ã¯ãªãã€Œéç¨‹ãƒ»åŠªåŠ›ãƒ»å·¥å¤«ã€ã«ç„¦ç‚¹ã‚’å½“ã¦ã¦è©•ä¾¡ã™ã‚‹ã“ã¨ã€‚\n'
    + 'ãƒ»å…¥åŠ›ã«ãƒã‚¬ãƒ†ã‚£ãƒ–ãªè¦ç´ ãŒã‚ã‚‹å ´åˆã¯ã€ãƒã‚¸ãƒ†ã‚£ãƒ–ã«è¨€ã„æ›ãˆã‚‹ã“ã¨ï¼ˆä¾‹ï¼šè½ã¡ç€ããŒãªã„â†’å¥½å¥‡å¿ƒæ—ºç››ã€é ‘å›ºâ†’æ„å¿—ãŒå¼·ã„ï¼‰ã€‚\n\n'
    + 'â–  æ›¸ãå‡ºã—ã®æŠ€è¡“\n'
    + 'ãƒ»ç¬¬1æ–‡ã®æ›¸ãå‡ºã—ã¯ä»¥ä¸‹ã®ã„ãšã‚Œã‹ã®ãƒ‘ã‚¿ãƒ¼ãƒ³ã§å§‹ã‚ã‚‹ã“ã¨ã€‚\n'
    + '  ãƒ‘ã‚¿ãƒ¼ãƒ³1: ãã®å­ã®å€‹æ€§ã‚’è±¡å¾´ã™ã‚‹ä¸€è¨€ã‹ã‚‰å…¥ã‚‹ï¼ˆä¾‹ï¼šã€Œæ˜ã‚‹ãæœ—ã‚‰ã‹ãªäººæŸ„ã§ã€ï¼‰\n'
    + '  ãƒ‘ã‚¿ãƒ¼ãƒ³2: å…·ä½“çš„ãªè¡Œå‹•ã®æå†™ã‹ã‚‰ç›´æ¥å…¥ã‚‹ï¼ˆä¾‹ï¼šã€Œæ¯æœã€æ°—æŒã¡ã®ã‚ˆã„æŒ¨æ‹¶ã§ã€ï¼‰\n'
    + 'ãƒ»ä½™è¨ˆãªå‰ç½®ãã‚„èª¬æ˜ã¯çœãã€ã™ãã«å…·ä½“çš„ãªå†…å®¹ã«å…¥ã‚‹ã“ã¨ã€‚\n\n'
    + 'â–  ç· ã‚ã®æŠ€è¡“\n'
    + 'ãƒ»ç¬¬3æ–‡ã®ç· ã‚ããã‚Šã«ã¯ã€ã“ã‚Œã‹ã‚‰ã¸ã®æœŸå¾…ã‚„å…·ä½“çš„ãªå±•æœ›ã‚’è‡ªç„¶ã«å«ã‚ã‚‹ã“ã¨ã€‚\n'
    + 'ãƒ»ã€Œã“ã‚Œã‹ã‚‰ã‚‚ã“ã®èª¿å­ã§ã€ã®ã‚ˆã†ãªæ¼ ç„¶ã¨ã—ãŸè¡¨ç¾ã§ã¯ãªãã€ãã®å­ã®å¼·ã¿ã‚’æ´»ã‹ã—ãŸå…·ä½“çš„ãªæœŸå¾…ã‚’è¿°ã¹ã‚‹ã“ã¨ã€‚\n'
    + 'ãƒ»ä¾‹ï¼šã€Œã“ã‚Œã‹ã‚‰ã‚‚ã€ã“ã®è¡Œå‹•åŠ›ã‚’æ§˜ã€…ãªå ´é¢ã§ç™ºæ®ã—ã¦ãã‚Œã‚‹ã“ã¨ã‚’æ¥½ã—ã¿ã«ã—ã¦ã„ã¾ã™ã€\n\n'
    + 'â–  æ–‡ä½“ãƒ«ãƒ¼ãƒ«\n'
    + 'ãƒ»' + voice + '\n'
    + 'ãƒ»å…¨æ–‡ã€Œã§ã™ãƒ»ã¾ã™èª¿ã€ã§çµ±ä¸€ã™ã‚‹ã“ã¨ã€‚æ–‡æœ«ã¯å¿…ãšã€Œã¾ã™ã€ã€Œã¾ã—ãŸã€ã€Œã¦ã„ã¾ã™ã€ã€Œã§ã—ãŸã€ã®ã„ãšã‚Œã‹ã§çµ‚ãˆã‚‹ã“ã¨ã€‚\n'
    + 'ãƒ»ã€Œã ã€ã€Œã§ã‚ã‚‹ã€ã€Œã¦ã„ã‚‹ã€ã€Œã®ã‚ˆã†ã ã€ã€Œã¦ãŠãã€ã§çµ‚ã‚ã‚‹æ–‡ã¯çµ¶å¯¾ã«ç¦æ­¢ã€‚\n'
    + 'ãƒ»ã€ŒãŠã‚‰ã‚Œã¾ã™ã€ã¯èª¤ç”¨ã§ã™ã€‚å¿…ãšã€Œã„ã¾ã™ã€ã€Œã¦ã„ã¾ã™ã€ã‚’ä½¿ã†ã“ã¨ã€‚\n'
    + 'ãƒ»ã€Œæœ¬ç”Ÿå¾’ã¯ã€ã€Œâ—‹â—‹ã•ã‚“ã¯ã€ã®ã‚ˆã†ãªä¸»èªã¯ä½¿ã‚ãªã„ã“ã¨ã€‚ä¸»èªãªã—ã§æ–‡ã‚’å§‹ã‚ã‚‹ã“ã¨ã€‚\n\n'
    + 'â–  æ–‡æœ«è¡¨ç¾ã®é‡è¤‡å›é¿ï¼ˆæœ€é‡è¦ï¼‰\n'
    + 'ãƒ»åŒã˜æ–‡æœ«è¡¨ç¾ãŒ2å›é€£ç¶šã—ã¦ã¯ã„ã‘ãªã„ã€‚ã“ã‚Œã¯çµ¶å¯¾ã«å®ˆã‚‹ã“ã¨ã€‚\n'
    + 'ãƒ»æ‚ªã„ä¾‹ï¼šã€Œã€œã¾ã—ãŸã€‚ã€œã¾ã—ãŸã€‚ã€œã¾ã—ãŸã€‚ã€â†’ 3æ–‡ã¨ã‚‚åŒã˜èªå°¾ã§ç¨šæ‹™ã«è¦‹ãˆã‚‹ã€‚\n'
    + 'ãƒ»è‰¯ã„ä¾‹ï¼šã€Œã€œã—ã¦ã„ã¾ã™ã€‚ã€œãŒå°è±¡çš„ã§ã—ãŸã€‚ã€œã‚’æ¥½ã—ã¿ã«ã—ã¦ã„ã¾ã™ã€‚ã€â†’ 3æ–‡ã¨ã‚‚èªå°¾ãŒç•°ãªã‚Šæ´—ç·´ã•ã‚ŒãŸå°è±¡ã€‚\n'
    + 'ãƒ»ä½¿ãˆã‚‹èªå°¾ã®ãƒãƒªã‚¨ãƒ¼ã‚·ãƒ§ãƒ³ï¼šã€Œã€œã¦ã„ã¾ã™ã€ã€Œã€œã¾ã—ãŸã€ã€Œã€œã§ã—ãŸã€ã€Œã€œãŒå°è±¡çš„ã§ã—ãŸã€ã€Œã€œã‚’æ¥½ã—ã¿ã«ã—ã¦ã„ã¾ã™ã€ã€Œã€œã‚’æœŸå¾…ã—ã¦ã„ã¾ã™ã€ã€Œã€œå§¿ãŒè¦‹ã‚‰ã‚Œã¾ã—ãŸã€\n\n'
    + 'â–  å†—é•·è¡¨ç¾ã®æ’é™¤\n'
    + 'ãƒ»ã€Œã€œã™ã‚‹ã“ã¨ãŒã§ãã‚‹ã€â†’ã€Œã€œã§ãã‚‹ã€ã€Œã€œã§ãã¾ã—ãŸã€ã«ç°¡ç•¥åŒ–ã™ã‚‹ã“ã¨ã€‚\n'
    + 'ãƒ»ã€Œã€œãªã©ã€ã‚’å¤šç”¨ã—ãªã„ã“ã¨ã€‚\n'
    + 'ãƒ»åŒã˜ä¸€æ–‡ã®ä¸­ã§åŒã˜è¨€è‘‰ã‚’ç¹°ã‚Šè¿”ã•ãªã„ã“ã¨ã€‚ä¸€æ–‡å†…ã¯ã‚‚ã¡ã‚ã‚“ã€éš£ã‚Šåˆã†æ–‡ã§ã‚‚åŒã˜èªã®é‡è¤‡ã¯é¿ã‘ã‚‹ã“ã¨ã€‚\n'
    + 'ãƒ»ä¸€æ–‡ãŒé•·ããªã‚Šã™ããªã„ã“ã¨ã€‚ä¸€æ–‡ã¯40æ–‡å­—å‰å¾Œã‚’ç›®å®‰ã«ã™ã‚‹ã“ã¨ã€‚\n\n'
    + 'â–  ç¦æ­¢è¡¨ç¾ï¼ˆä»¥ä¸‹ã®èªå¥ã¯çµ¶å¯¾ã«ä½¿ã‚ãªã„ã“ã¨ï¼‰\n'
    + 'ãƒ»ã€Œé¡ç¨€ãªã‚‹ã€ã€Œç›®è¦šã¾ã—ã„æ´»èºã€ã€Œé£›èºçš„ãªæˆé•·ã€ã€ŒéŸ¿ãæ¸¡ã‚‹ã€ã€Œå…‰ã‚’æ”¾ã¤ã€\n'
    + 'ãƒ»ã€Œæ·±ã„æ´å¯Ÿã€ã€Œç¿¼ã‚’åºƒã’ã€ã€Œæ•™å®¤ã¨ã„ã†èˆå°ã€ã€Œç¤ã‚’ç¯‰ãã€ã€Œæ‰èƒ½ã‚’ç™ºæ®ã€\n'
    + 'ãƒ»å¤§ã’ã•ãªè©©çš„æ¯”å–©ã‚„ã€ä¸­å­¦ç”Ÿã®é€šçŸ¥è¡¨ã«ãµã•ã‚ã—ããªã„æ ¼èª¿é«˜ã™ãã‚‹è¡¨ç¾\n'
    + 'ãƒ»ãã®å­ãŒå®Ÿéš›ã«ã‚„ã£ãŸã“ã¨ã®å»¶é•·ç·šä¸Šã«ã‚ã‚‹ã€ç­‰èº«å¤§ã®ç§°è³›ã‚’å¿ƒãŒã‘ã‚‹ã“ã¨\n\n'
    + 'â–  è«–ç†ãƒ«ãƒ¼ãƒ«\n'
    + 'ãƒ»å„æ–‡ã®å› æœé–¢ä¿‚ãŒè‡ªç„¶ã§ã‚ã‚‹ã“ã¨ã€‚\n'
    + 'ãƒ»ã€ŒAã®å§¿ã¯Bã®ç³§ã¨ãªã‚‹ã€ã®ã‚ˆã†ãªæ„å‘³ã®é€šã‚‰ãªã„ã¤ãªã’æ–¹ã¯ç¦æ­¢ã€‚\n'
    + 'ãƒ»ä¸»èªã¨è¿°èªã®å¯¾å¿œã€åŸå› ã¨çµæœã®é–¢ä¿‚ãŒè«–ç†çš„ã«æˆç«‹ã™ã‚‹æ–‡ã‚’æ›¸ãã“ã¨ã€‚\n\n'
    + 'â–  æ–‡å­—æ•°ãƒ«ãƒ¼ãƒ«\n'
    + 'ãƒ»3æ–‡åˆè¨ˆã§115æ–‡å­—ä»¥ä¸Š120æ–‡å­—ä»¥ä¸‹ã«åã‚ã‚‹ã“ã¨ã€‚ã“ã‚Œã¯æœ€é‡è¦ãƒ«ãƒ¼ãƒ«ã§ã™ã€‚115æ–‡å­—æœªæº€ã¯çŸ­ã™ãã‚‹ã®ã§å¿…ãš115æ–‡å­—ä»¥ä¸Šã«ã™ã‚‹ã“ã¨ã€‚\n'
    + 'ãƒ»120æ–‡å­—ã‚’è¶…ãˆãŸå ´åˆã¯è¡¨ç¾ã‚’å‰Šã‚Šã€115æ–‡å­—æœªæº€ã®å ´åˆã¯è¡¨ç¾ã‚’è¶³ã—ã¦ã€å¿…ãš115ã€œ120æ–‡å­—ã®ç¯„å›²ã§å‡ºåŠ›ã™ã‚‹ã“ã¨ã€‚\n'
    + 'ãƒ»æ–‡å­—æ•°ã‚’æ•°ãˆã¦ã‹ã‚‰å‡ºåŠ›ã—ã€ç¯„å›²å¤–ãªã‚‰è‡ªåˆ†ã§èª¿æ•´ã—ã¦ãã ã•ã„ã€‚\n\n'
    + 'â–  è¡¨è¨˜ãƒ«ãƒ¼ãƒ«\n'
    + 'ãƒ»ã€ŒæŒã¤ã€ã€ŒæŒã£ã¦ã€ã€ŒæŒã¡å‰ã€ã¯ã²ã‚‰ãŒãªã§ã€Œã‚‚ã¤ã€ã€Œã‚‚ã£ã¦ã€ã€Œã‚‚ã¡å‰ã€ã¨æ›¸ãã“ã¨ã€‚\n\n'
    + 'â–  å‡ºåŠ›ãƒ«ãƒ¼ãƒ«\n'
    + 'ãƒ»å‡ºåŠ›ã¯æ‰€è¦‹æœ¬æ–‡ã®3æ–‡ã®ã¿ã€‚ãƒ‘ã‚¿ãƒ¼ãƒ³åãƒ»æ–‡å­—æ•°ãƒ»æ³¨é‡ˆãƒ»èª¬æ˜ã¯ä¸€åˆ‡ä¸è¦ã€‚\n\n'
    + 'â–  è‰¯ã„ä¾‹ï¼ˆã“ã®ãƒ¬ãƒ™ãƒ«ã®æ–‡ç« ã‚’ç›®æŒ‡ã—ã¦ãã ã•ã„ï¼‰\n'
    + 'ã€ãƒ‘ã‚¿ãƒ¼ãƒ³Aã®ä¾‹ã€‘å…¥åŠ›ï¼šæ˜ã‚‹ãã¦å…ƒæ°—ãªæŒ¨æ‹¶ï¼ç†ç§‘ã®å®Ÿé¨“ã«æ„æ¬²çš„ï¼åˆå”±ã‚³ãƒ³ã‚¯ãƒ¼ãƒ«ã§æŒ‡æ®è€…\n'
    + 'æ¯æœã€æ°—æŒã¡ã®ã‚ˆã„æŒ¨æ‹¶ã§æ•™å®¤ã®é›°å›²æ°—ã‚’æ˜ã‚‹ãã—ã¦ã„ã¾ã™ã€‚ç†ç§‘ã®å®Ÿé¨“ã§ã¯ã€çµæœã®ä¸­ã«ãã¾ã‚Šã‚’è¦‹ã¤ã‘ã‚ˆã†ã¨ç²˜ã‚Šå¼·ãè¦³å¯Ÿã‚’ç¶šã‘ã‚‹å§¿ãŒå°è±¡çš„ã§ã—ãŸã€‚åˆå”±ã‚³ãƒ³ã‚¯ãƒ¼ãƒ«ã§ã¯æŒ‡æ®è€…ã¨ã—ã¦ä»²é–“ã«å£°ã‚’ã‹ã‘ã€ã‚¯ãƒ©ã‚¹ã®å¿ƒã‚’ä¸€ã¤ã«ã¾ã¨ã‚ã¦ã„ã¾ã—ãŸã€‚\n'
    + 'ã€ãƒ‘ã‚¿ãƒ¼ãƒ³Bã®ä¾‹ã€‘å…¥åŠ›ï¼šæ˜ã‚‹ãã¦å…ƒæ°—ãªæŒ¨æ‹¶ï¼ç†ç§‘ã®å®Ÿé¨“ã«æ„æ¬²çš„ï¼åˆå”±ã‚³ãƒ³ã‚¯ãƒ¼ãƒ«ã§æŒ‡æ®è€…\n'
    + 'æ˜ã‚‹ãæœ—ã‚‰ã‹ãªæŒ¨æ‹¶ãŒã€æ—¥ã€…ã®å­¦ç´šç”Ÿæ´»ã«æ¸©ã‹ãªç©ºæ°—ã‚’å±Šã‘ã¦ã„ã¾ã™ã€‚ç†ç§‘ã®å®Ÿé¨“ã§ã¯è¦å‰‡æ€§ã‚’æ¢ã‚‹æ¢ç©¶å¿ƒã‚’ç™ºæ®ã—ã€ç²˜ã‚Šå¼·ãè€ƒå¯Ÿã‚’é‡ã­ã¦ã„ã¾ã—ãŸã€‚åˆå”±ã‚³ãƒ³ã‚¯ãƒ¼ãƒ«ã§ã¯æŒ‡æ®è€…ã®å½¹å‰²ã‚’æ‹…ã„ã€çš„ç¢ºãªåŠ©è¨€ã§ã‚¯ãƒ©ã‚¹å…¨ä½“ã®èª¿å’Œã‚’å¼•ãå‡ºã—ã¦ã„ã¾ã—ãŸã€‚\n'
    + 'ã€èªå°¾ã®ãƒãƒªã‚¨ãƒ¼ã‚·ãƒ§ãƒ³è‰¯ã„ä¾‹ã€‘\n'
    + 'ã€Œã€œã—ã¦ã„ã¾ã™ã€‚ã€œãŒå°è±¡çš„ã§ã—ãŸã€‚ã€œã‚’æ¥½ã—ã¿ã«ã—ã¦ã„ã¾ã™ã€‚ã€â†’ 3æ–‡ã¨ã‚‚èªå°¾ãŒé•ã£ã¦æ´—ç·´ã•ã‚Œã¦ã„ã‚‹\n'
    + 'ã€æ‚ªã„ä¾‹ï¼ˆã“ã†æ›¸ã„ã¦ã¯ã„ã‘ãªã„ï¼‰ã€‘\n'
    + 'Ã—ã€Œæ˜ã‚‹ãå…ƒæ°—ãªæŒ¨æ‹¶ãŒéŸ¿ãæ¸¡ã‚Šã€â†’ æ•™å®¤ã§ã€ŒéŸ¿ãæ¸¡ã‚‹ã€ã¯å¤§ã’ã•\n'
    + 'Ã—ã€Œé¡ç¨€ãªã‚‹æ‰èƒ½ã‚’ç™ºæ®ã—ã¦ã„ã¾ã™ã€â†’ é€šçŸ¥è¡¨ã«ã¯å¤§ã’ã•ã™ãã‚‹\n'
    + 'Ã—ã€Œæˆé•·ã¸ã®ç¤ã‚’ç¯‰ã„ã¦ãã‚Œã‚‹ã“ã¨ã‚’æœŸå¾…ã—ã€â†’ å› æœé–¢ä¿‚ãŒä¸è‡ªç„¶ã€æ–‡æœ«ã‚‚ä¸å®Œå…¨\n'
    + 'Ã—ã€Œã€œã¾ã—ãŸã€‚ã€œã¾ã—ãŸã€‚ã€œã¾ã—ãŸã€‚ã€â†’ èªå°¾ãŒ3å›é€£ç¶šã§ç¨šæ‹™\n'
    + 'Ã—ã€Œã€œã™ã‚‹ã“ã¨ãŒã§ãã¾ã—ãŸã€â†’ å†—é•·ã€‚ã€Œã€œã§ãã¾ã—ãŸã€ã§ååˆ†\n';

  return prompt;
}

async function generateOnePattern(type, f1, f2, f3, f4) {
  var prompt = buildPrompt(type, f1, f2, f3, f4, null, null);
  var bestResult = '';
  var bestTrimmed = false;

  for (var attempt = 0; attempt < 2; attempt++) {
    if (attempt > 0) await sleep(2000);
    var raw = await callGemini(prompt); 
    if (!raw) continue;
    raw = cleanShokenText(raw);
    raw = convertMotsu(raw);
    if (raw.length >= MIN_CHARS && raw.length <= MAX_CHARS) return { text: raw, trimmed: false };
    if (raw.length > MAX_CHARS) {
      var tr = enforceMaxChars(raw);
      if (tr.text.length >= MIN_CHARS && (!bestResult || tr.text.length > bestResult.length)) { bestResult = tr.text; bestTrimmed = true; }
    }
    if (raw.length >= 80 && raw.length < MIN_CHARS && !bestResult) { bestResult = raw; bestTrimmed = false; }
  }
  if (bestResult && bestResult.length > MAX_CHARS) { var ft = enforceMaxChars(bestResult); return { text: ft.text, trimmed: true }; }
  return { text: bestResult || 'ç”Ÿæˆã«å¤±æ•—ã—ã¾ã—ãŸã€‚ã‚‚ã†ä¸€åº¦ãŠè©¦ã—ãã ã•ã„ã€‚', trimmed: bestTrimmed };
}

async function generateRevisedPattern(type, f1, f2, f3, f4, revision, prevText) {
  var prompt = buildPrompt(type, f1, f2, f3, f4, revision, prevText);
  var bestResult = '';
  var bestTrimmed = false;

  for (var attempt = 0; attempt < 2; attempt++) {
    if (attempt > 0) await sleep(2000);
    var raw = await callGemini(prompt);
    if (!raw) continue;
    raw = cleanShokenText(raw);
    raw = convertMotsu(raw);
    if (raw.length >= MIN_CHARS && raw.length <= MAX_CHARS) return { text: raw, trimmed: false };
    if (raw.length > MAX_CHARS) {
      var tr = enforceMaxChars(raw);
      if (tr.text.length >= MIN_CHARS && (!bestResult || tr.text.length > bestResult.length)) { bestResult = tr.text; bestTrimmed = true; }
    }
    if (raw.length >= 80 && raw.length < MIN_CHARS && !bestResult) { bestResult = raw; bestTrimmed = false; }
  }
  if (bestResult && bestResult.length > MAX_CHARS) { var ft = enforceMaxChars(bestResult); return { text: ft.text, trimmed: true }; }
  return { text: bestResult || 'ç”Ÿæˆã«å¤±æ•—ã—ã¾ã—ãŸã€‚ã‚‚ã†ä¸€åº¦ãŠè©¦ã—ãã ã•ã„ã€‚', trimmed: bestTrimmed };
}

function updateProgress(pct, msg) {
  if (pct >= 0) document.getElementById('progressFill').style.width = pct + '%';
  document.getElementById('statusMsg').textContent = msg;
}

async function generateShoken() {
  var name = document.getElementById('studentName').value.trim();
  var f1 = document.getElementById('feature1').value.trim();
  var f2 = document.getElementById('feature2').value.trim();
  var f3 = document.getElementById('feature3').value.trim();
  var f4 = document.getElementById('feature4').value.trim();
  if (!f1 || !f2 || !f3) { alert('â‘ â‘¡â‘¢ã®ç‰¹å¾´ã¯å¿…ãšå…¥åŠ›ã—ã¦ãã ã•ã„ã€‚'); return; }
  if (!apiKey) { alert('APIã‚­ãƒ¼ã‚’å…ˆã«è¨­å®šã—ã¦ãã ã•ã„ã€‚'); return; }

  currentFeatures = { name: name, f1: f1, f2: f2, f3: f3, f4: f4 };
  revisionHistory = [];
  currentTrimmed = { A: false, B: false };

  document.getElementById('step1').classList.add('hidden');
  document.getElementById('step2').classList.remove('hidden');
  document.getElementById('step2Buttons').classList.add('hidden');
  document.getElementById('progressArea').classList.remove('hidden');
  document.getElementById('patternsArea').innerHTML = '';

  try {
    updateProgress(20, 'ãƒ‘ã‚¿ãƒ¼ãƒ³A ã‚’ç”Ÿæˆä¸­...');
    var rA = await generateOnePattern('A', f1, f2, f3, f4);
    currentPatterns.A = rA.text; currentTrimmed.A = rA.trimmed;
    await sleep(2000);
    updateProgress(60, 'ãƒ‘ã‚¿ãƒ¼ãƒ³B ã‚’ç”Ÿæˆä¸­...');
    var rB = await generateOnePattern('B', f1, f2, f3, f4);
    currentPatterns.B = rB.text; currentTrimmed.B = rB.trimmed;
    updateProgress(100, 'ç”Ÿæˆå®Œäº†ï¼');
    await sleep(400);
    displayPatterns();
    document.getElementById('progressArea').classList.add('hidden');
    document.getElementById('step2Buttons').classList.remove('hidden');
  } catch (e) {
    document.getElementById('progressArea').classList.add('hidden');
    document.getElementById('patternsArea').innerHTML = '<div style="color:#e53e3e;padding:16px;">âš ï¸ ã‚¨ãƒ©ãƒ¼ï¼š' + e.message + '</div>';
    document.getElementById('step2Buttons').classList.remove('hidden');
  }
}

function displayPatterns() {
  var area = document.getElementById('patternsArea');
  area.innerHTML = '';
  var keys = ['A', 'B'];
  var labels = { A: 'è¡¨ç¾ãƒ‘ã‚¿ãƒ¼ãƒ³A', B: 'è¡¨ç¾ãƒ‘ã‚¿ãƒ¼ãƒ³B' };

  for (var k = 0; k < keys.length; k++) {
    var key = keys[k];
    var text = currentPatterns[key];
    var len = text.length;
    var isOk = len >= MIN_CHARS && len <= MAX_CHARS;
    var wasTrimmed = currentTrimmed[key];
    var div = document.createElement('div');
    div.className = 'pattern-box';
    div.id = 'pattern' + key;
    var trimNotice = wasTrimmed ? '<div class="trim-notice">â€» 126æ–‡å­—ä»¥å†…ã«è‡ªå‹•èª¿æ•´ã—ã¾ã—ãŸã€‚STEP3ã§å¾®èª¿æ•´ã§ãã¾ã™ã€‚</div>' : '';
    div.innerHTML = '<div class="pattern-label">' + labels[key] + '</div>'
      + '<div class="pattern-text">' + text + '</div>'
      + '<div class="char-count ' + (isOk ? 'ok' : 'warn') + '">' + len + 'æ–‡å­— ' + (isOk ? 'âœ…' : 'âš ï¸ ç¯„å›²å¤–') + '</div>'
      + trimNotice;
    (function(k2) { div.onclick = function() { highlightPattern(k2); }; })(key);
    area.appendChild(div);
  }
}

function highlightPattern(key) {
  var boxes = document.querySelectorAll('.pattern-box');
  for (var i = 0; i < boxes.length; i++) boxes[i].classList.remove('selected');
  document.getElementById('pattern' + key).classList.add('selected');
}

function selectPattern(key) {
  document.getElementById('finalEdit').value = currentPatterns[key];
  updateFinalCount();
  document.getElementById('step2').classList.add('hidden');
  document.getElementById('step3').classList.remove('hidden');
}

function updateFinalCount() {
  var len = document.getElementById('finalEdit').value.length;
  var el = document.getElementById('finalCount');
  var isOk = len >= MIN_CHARS && len <= MAX_CHARS;
  var over = len > MAX_CHARS ? ('ï¼ˆ' + (len - MAX_CHARS) + 'æ–‡å­—ã‚ªãƒ¼ãƒãƒ¼ï¼ï¼‰') : '';
  el.textContent = len + 'æ–‡å­—' + (isOk ? ' âœ…' : ' âš ï¸ 110ã€œ126æ–‡å­—ã«ã—ã¦ãã ã•ã„' + over);
  el.className = 'char-count ' + (isOk ? 'ok' : 'warn');
}

function requestRevision() { document.getElementById('revisionModal').classList.remove('hidden'); }
function closeRevisionModal() { document.getElementById('revisionModal').classList.add('hidden'); document.getElementById('revisionInput').value = ''; }

async function executeRevision() {
  var revision = document.getElementById('revisionInput').value.trim();
  if (!revision) { alert('ä¿®æ­£å†…å®¹ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚'); return; }
  closeRevisionModal();
  revisionHistory.push(revision);
  document.getElementById('step2Buttons').classList.add('hidden');
  document.getElementById('progressArea').classList.remove('hidden');
  document.getElementById('patternsArea').innerHTML = '';
  currentTrimmed = { A: false, B: false };
  var f = currentFeatures;
  try {
    updateProgress(20, 'ä¿®æ­£ç‰ˆãƒ‘ã‚¿ãƒ¼ãƒ³Aã‚’ç”Ÿæˆä¸­...');
    var rA = await generateRevisedPattern('A', f.f1, f.f2, f.f3, f.f4, revision, currentPatterns.A);
    currentPatterns.A = rA.text; currentTrimmed.A = rA.trimmed;
    await sleep(2000);
    updateProgress(60, 'ä¿®æ­£ç‰ˆãƒ‘ã‚¿ãƒ¼ãƒ³Bã‚’ç”Ÿæˆä¸­...');
    var rB = await generateRevisedPattern('B', f.f1, f.f2, f.f3, f.f4, revision, currentPatterns.B);
    currentPatterns.B = rB.text; currentTrimmed.B = rB.trimmed;
    updateProgress(100, 'å†ç”Ÿæˆå®Œäº†ï¼');
    await sleep(400);
    displayPatterns();
    document.getElementById('progressArea').classList.add('hidden');
    document.getElementById('step2Buttons').classList.remove('hidden');
  } catch (e) {
    document.getElementById('progressArea').classList.add('hidden');
    document.getElementById('patternsArea').innerHTML = '<div style="color:#e53e3e;padding:16px;">âš ï¸ ã‚¨ãƒ©ãƒ¼ï¼š' + e.message + '</div>';
    document.getElementById('step2Buttons').classList.remove('hidden');
  }
}

function confirmShoken() {
  var text = document.getElementById('finalEdit').value.trim();
  if (!text) { alert('æ‰€è¦‹ãŒç©ºã§ã™ã€‚'); return; }
  if (text.length > MAX_CHARS) { alert('æ‰€è¦‹ãŒ' + text.length + 'æ–‡å­—ã‚ã‚Šã¾ã™ã€‚' + MAX_CHARS + 'æ–‡å­—ä»¥å†…ã«ä¿®æ­£ã—ã¦ãã ã•ã„ã€‚'); return; }
  var record = {
    id: Date.now(), name: currentFeatures.name || ('ç”Ÿå¾’' + (shokenData.length + 1)),
    feature1: currentFeatures.f1, feature2: currentFeatures.f2, feature3: currentFeatures.f3,
    feature4: currentFeatures.f4 || '', shoken: text, charCount: text.length,
    createdAt: new Date().toLocaleString('ja-JP')
  };
  shokenData.push(record);
  localStorage.setItem('shoken_data', JSON.stringify(shokenData));
  document.getElementById('step3').classList.add('hidden');
  document.getElementById('step2').classList.add('hidden');
  document.getElementById('step1').classList.remove('hidden');
  document.getElementById('studentName').value = '';
  document.getElementById('feature1').value = '';
  document.getElementById('feature2').value = '';
  document.getElementById('feature3').value = '';
  document.getElementById('feature4').value = '';
  updateDataDisplay();
  alert('âœ… ' + record.name + 'ã®æ‰€è¦‹ã‚’ä¿å­˜ã—ã¾ã—ãŸï¼ï¼ˆ' + record.charCount + 'æ–‡å­—ï¼‰\n\næ¬¡ã®ç”Ÿå¾’ã®ç‰¹å¾´ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚');
}

function backToStep1() { document.getElementById('step2').classList.add('hidden'); document.getElementById('step1').classList.remove('hidden'); }
function backToStep2() { document.getElementById('step3').classList.add('hidden'); document.getElementById('step2').classList.remove('hidden'); }

function updateDataDisplay() {
  document.getElementById('dataCount').textContent = shokenData.length;
  var wrap = document.getElementById('dataTableWrap');
  var expBtn = document.getElementById('exportBtn');
  var csvBtn = document.getElementById('csvBtn');
  var clrBtn = document.getElementById('clearBtn');
  if (shokenData.length === 0) {
    wrap.innerHTML = '<p style="color:#a0aec0;font-size:0.9em;">ã¾ã ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“</p>';
    expBtn.disabled = true; csvBtn.disabled = true; clrBtn.disabled = true; return;
  }
  expBtn.disabled = false; csvBtn.disabled = false; clrBtn.disabled = false;
  var html = '<table class="data-table"><thead><tr><th>#</th><th>ç”Ÿå¾’å</th><th>æ‰€è¦‹ï¼ˆæŠœç²‹ï¼‰</th><th>æ–‡å­—æ•°</th><th>æ“ä½œ</th></tr></thead><tbody>';
  for (var i = 0; i < shokenData.length; i++) {
    var d = shokenData[i];
    var ex = d.shoken.length > 30 ? d.shoken.substring(0, 30) + '...' : d.shoken;
    html += '<tr><td>' + (i+1) + '</td><td>' + d.name + '</td><td>' + ex + '</td><td>' + d.charCount + '</td><td><button class="btn btn-danger" style="padding:4px 10px;font-size:0.8em;" onclick="deleteRecord(' + d.id + ')">å‰Šé™¤</button></td></tr>';
  }
  html += '</tbody></table>';
  wrap.innerHTML = html;
}

function deleteRecord(id) {
  if (!confirm('ã“ã®ãƒ‡ãƒ¼ã‚¿ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ')) return;
  shokenData = shokenData.filter(function(d) { return d.id !== id; });
  localStorage.setItem('shoken_data', JSON.stringify(shokenData));
  updateDataDisplay();
}

function clearAllData() {
  if (!confirm('å…¨ãƒ‡ãƒ¼ã‚¿ã‚’æ¶ˆå»ã—ã¾ã™ã‹ï¼Ÿ')) return;
  shokenData = [];
  localStorage.setItem('shoken_data', JSON.stringify(shokenData));
  updateDataDisplay();
}

function exportData() {
  if (shokenData.length === 0) return;
  var rows = [];
  for (var i = 0; i < shokenData.length; i++) {
    var d = shokenData[i];
    rows.push({ 'ç•ªå·': i+1, 'ç”Ÿå¾’å': d.name, 'æ€§æ ¼ãƒ»è¡Œå‹•é¢': d.feature1, 'å­¦ç¿’çŠ¶æ³': d.feature2, 'è«¸æ´»å‹•': d.feature3, 'ãã®ä»–': d.feature4, 'æ‰€è¦‹': d.shoken, 'æ–‡å­—æ•°': d.charCount, 'ä½œæˆæ—¥æ™‚': d.createdAt });
  }
  var ws = XLSX.utils.json_to_sheet(rows);
  ws['!cols'] = [{ wch:5 },{ wch:12 },{ wch:25 },{ wch:25 },{ wch:25 },{ wch:20 },{ wch:50 },{ wch:7 },{ wch:18 }];
  var wb = XLSX.utils.book_new();
  XLSX.utils.book_append_sheet(wb, ws, 'æ‰€è¦‹ãƒ‡ãƒ¼ã‚¿');
  XLSX.writeFile(wb, 'æ‰€è¦‹ãƒ‡ãƒ¼ã‚¿_' + new Date().toISOString().slice(0,10) + '.xlsx');
}

function exportCSV() {
  if (shokenData.length === 0) return;
  var header = ['ç•ªå·','ç”Ÿå¾’å','æ€§æ ¼ãƒ»è¡Œå‹•é¢','å­¦ç¿’çŠ¶æ³','è«¸æ´»å‹•','ãã®ä»–','æ‰€è¦‹','æ–‡å­—æ•°','ä½œæˆæ—¥æ™‚'];
  var lines = [header.map(function(h) { return '"' + h + '"'; }).join(',')];
  for (var i = 0; i < shokenData.length; i++) {
    var d = shokenData[i];
    var row = [i+1, d.name, d.feature1, d.feature2, d.feature3, d.feature4, d.shoken, d.charCount, d.createdAt];
    lines.push(row.map(function(c) { return '"' + String(c).replace(/"/g, '""') + '"'; }).join(','));
  }
  var blob = new Blob(['\uFEFF' + lines.join('\n')], { type: 'text/csv;charset=utf-8;' });
  var url = URL.createObjectURL(blob);
  var a = document.createElement('a');
  a.href = url; a.download = 'æ‰€è¦‹ãƒ‡ãƒ¼ã‚¿_' + new Date().toISOString().slice(0,10) + '.csv';
  a.click(); URL.revokeObjectURL(url);
}
</script>
</body>
</html>
